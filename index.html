<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced System Benchmark Suite</title>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Google Sans', sans-serif;
            background: #050505;
            color: #666;
            padding: 40px 20px;
            overflow-x: hidden;
            text-transform: lowercase;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header { text-align: center; margin-bottom: 40px; }
        .header h1 { color: #444; font-size: 1.8em; margin-bottom: 8px; font-weight: 500; letter-spacing: -0.5px; }
        .header p { color: #333; font-size: 0.9em; font-weight: 500; }

        .status-msg { text-align: center; font-size: 0.75em; margin-bottom: 30px; color: #333; }
        .status-msg.error { color: #a55; }
        .status-msg.active { color: #4a4; }

        .controls { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
        
        input[type="text"] {
            background: #111;
            border: 1px solid #222;
            padding: 12px 15px;
            border-radius: 6px;
            color: #888;
            font-family: 'Google Sans', sans-serif;
            font-size: 0.9em;
            outline: none;
            width: 200px;
        }
        input[type="text"]:focus { border-color: #444; }

        button {
            padding: 12px 35px;
            font-size: 0.95em;
            border: 1px solid #222;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            font-family: 'Google Sans', sans-serif;
            background: #111;
            color: #555;
            text-transform: lowercase;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        button:hover:not(:disabled) { background: #222; border-color: #333; color: #888; }
        button:disabled { opacity: 0.3; cursor: not-allowed; }
        
        #reconnectBtn { background: #201010; border-color: #402020; color: #a05050; display: none; }

        .overall-score {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px;
            background: linear-gradient(180deg, #0f0f0f 0%, #050505 100%);
            border-radius: 12px;
            border: 1px solid #1a1a1a;
            width: 100%;
            max-width: 800px;
        }
        .overall-score h2 { font-size: 0.9em; color: #444; margin-bottom: 10px; font-weight: 500; }
        .score-value {
            font-size: 4em;
            color: #888;
            font-weight: 500;
            letter-spacing: -2px;
            height: 1.2em;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .timer { color: #333; font-size: 0.9em; margin-top: 15px; font-weight: 500; }

        .leaderboard-wrapper {
            width: 100%;
            max-width: 800px;
            margin: 0 auto 50px auto;
            border: 1px solid #1a1a1a;
            border-radius: 8px;
            background: #080808;
            overflow: hidden;
        }
        .leaderboard-header {
            padding: 15px 20px;
            background: #0c0c0c;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #1a1a1a;
            color: #555;
            font-size: 0.9em;
        }
        .leaderboard-table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        .leaderboard-table th { text-align: left; padding: 12px 20px; color: #333; border-bottom: 1px solid #111; font-weight: 500; }
        .leaderboard-table td { padding: 12px 20px; color: #666; border-bottom: 1px solid #0f0f0f; }
        .leaderboard-content { height: auto; max-height: 400px; overflow-y: auto; background: #080808; }

        .benchmark-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
            width: 100%;
            max-width: 1000px;
        }
        .benchmark-card { 
            background: #0c0c0c; 
            border-radius: 8px; 
            padding: 24px; 
            border: 1px solid #1a1a1a; 
            transition: all 0.3s ease; 
        }
        .benchmark-card.running { border-color: #2a2a2a; background: #0e0e0e; }
        .benchmark-title { color: #555; font-size: 0.9em; margin-bottom: 12px; font-weight: 500; display: flex; justify-content: space-between; }
        .benchmark-score { color: #777; font-size: 2.2em; font-weight: 500; margin: 15px 0; height: 1.2em; display: flex; align-items: center; }
        .progress-bar { width: 100%; height: 2px; background: #111; margin: 20px 0; border-radius: 1px; }
        .progress-fill { height: 100%; background: #444; width: 0%; transition: width 0.1s linear; }
        .metric { display: flex; justify-content: space-between; font-size: 0.85em; color: #444; margin: 4px 0; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #050505; }
        ::-webkit-scrollbar-thumb { background: #222; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Advanced System Benchmark</h1>
        <p>Unpredictable Logic Stress Test / Global Leaderboard</p>
    </div>

    <div class="status-msg" id="authStatus">Initializing secure session...</div>

    <div class="controls">
        <input type="text" id="userName" placeholder="enter your name" maxlength="15">
        <button id="startBtn" onclick="startBenchmark()" disabled>start</button>
        <button id="stopBtn" onclick="stopBenchmark()" disabled>stop</button>
        <button id="reconnectBtn" onclick="initAuth()">reconnect</button>
    </div>

    <div class="overall-score">
        <h2>System performance score</h2>
        <div class="score-value" id="overallScore">0</div>
        <div class="timer" id="timer">0.0s / 60.0s</div>
    </div>

    <div class="leaderboard-wrapper">
        <div class="leaderboard-header">
            <span>Top Global Rankings</span>
            <span style="font-size: 0.8em; opacity: 0.5;" id="path-indicator">PATH: /leaderboard</span>
        </div>
        <div class="leaderboard-content" id="leaderboardContent">
            <table class="leaderboard-table">
                <thead>
                    <tr>
                        <th style="width: 50px">#</th>
                        <th>name</th>
                        <th style="text-align: right;">score</th>
                        <th style="text-align: right;">date</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body">
                    <tr><td colspan="4" style="text-align: center; padding: 30px;">connecting to global database...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="benchmark-grid" id="benchmarkGrid"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        // CHANGED: Defaulting to FALSE as requested.
        // Set to TRUE only if you need to debug in the Canvas Preview environment.
        const IS_CANVAS_ENV = false; 

        const prodConfig = {
            apiKey: "AIzaSyCjSl69biNUauSyc5PY6SmUYfcpIwv43OI",
            authDomain: "benchbackend.firebaseapp.com",
            projectId: "benchbackend",
            storageBucket: "benchbackend.firebasestorage.app",
            messagingSenderId: "964026070166",
            appId: "1:964026070166:web:71c4a6eb59edfab03f7eb7"
        };

        const isCanvas = typeof __firebase_config !== 'undefined';
        const firebaseConfig = isCanvas ? JSON.parse(__firebase_config) : prodConfig;
        const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'benchmark-default';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let user = null;
        let unsubscribeLeaderboard = null;

        // --- EXPOSE TO WINDOW ---
        window.initAuth = async function(retries = 5) {
            updateStatus("", "connecting to database...");
            try {
                if (initialToken && isCanvas) {
                    await signInWithCustomToken(auth, initialToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth error:", error);
                if (retries > 0) {
                    setTimeout(() => window.initAuth(retries - 1), 1500);
                } else {
                    updateStatus("error", "connection failed - offline mode");
                    document.getElementById('reconnectBtn').style.display = 'inline-block';
                    document.getElementById('startBtn').disabled = false;
                }
            }
        }

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (u) {
                updateStatus("active", "connected securely");
                document.getElementById('startBtn').disabled = false;
                document.getElementById('reconnectBtn').style.display = 'none';
                setupLeaderboard();
            }
        });

        function updateStatus(type, msg) {
            const el = document.getElementById('authStatus');
            el.className = `status-msg ${type}`;
            el.textContent = msg;
        }

        function setupLeaderboard() {
            if (!user) return;
            if (unsubscribeLeaderboard) unsubscribeLeaderboard();

            let q;
            
            if (IS_CANVAS_ENV && isCanvas) {
                // Nested path + Client-side sort (for Preview/Canvas)
                const colRef = collection(db, 'artifacts', currentAppId, 'public', 'data', 'leaderboard');
                document.getElementById('path-indicator').textContent = "ENV: PREVIEW";
                q = query(colRef); 
            } else {
                // Root path + Server-side sort (for Production)
                const colRef = collection(db, 'leaderboard');
                document.getElementById('path-indicator').textContent = "ENV: PROD";
                q = query(colRef, orderBy("score", "desc"), limit(20));
            }

            unsubscribeLeaderboard = onSnapshot(q, (snapshot) => {
                const entries = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.score) entries.push({ ...data, id: doc.id });
                });

                // Manual sort fallback for Canvas env or missing index
                if (IS_CANVAS_ENV || entries.length < 20) {
                    entries.sort((a, b) => b.score - a.score);
                }

                renderLeaderboard(entries.slice(0, 15));
            }, (error) => {
                console.error("Leaderboard error:", error);
                if (error.code === 'permission-denied') {
                    updateStatus("error", "database permission denied - check rules");
                }
            });
        }

        function renderLeaderboard(data) {
            const tbody = document.getElementById('leaderboard-body');
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 30px;">no global scores yet.</td></tr>`;
                return;
            }

            tbody.innerHTML = data.map((entry, index) => {
                const date = entry.timestamp ? new Date(entry.timestamp.toDate()).toLocaleDateString() : 'recent';
                const isMe = user && entry.uid === user.uid ? 'color: #ccc; font-weight: 500;' : '';
                return `
                    <tr style="${isMe}">
                        <td>${index + 1}</td>
                        <td>${entry.name || 'anonymous'}</td>
                        <td style="text-align: right;">${Math.floor(entry.score).toLocaleString()}</td>
                        <td style="text-align: right; color: #444;">${date}</td>
                    </tr>
                `;
            }).join('');
        }

        window.uploadScore = async function(name, score) {
            if (!user) return;
            
            try {
                let colRef;
                if (IS_CANVAS_ENV && isCanvas) {
                    colRef = collection(db, 'artifacts', currentAppId, 'public', 'data', 'leaderboard');
                } else {
                    colRef = collection(db, 'leaderboard');
                }

                await addDoc(colRef, {
                    uid: user.uid,
                    name: name || 'user',
                    score: Number(score),
                    timestamp: serverTimestamp(),
                    device: navigator.platform || 'unknown'
                });
                
                updateStatus("active", "score synchronized!");
            } catch (err) {
                console.error("Upload error:", err);
                updateStatus("error", "upload failed: check permissions");
            }
        }
        
        // Start Auth
        window.initAuth();
    </script>

    <script>
        // --- CORE BENCHMARK ENGINE (Optimized) ---
        const BENCH_CONFIG = {
            duration: 60000,
            tickRate: 10,
            calcChunk: 100
        };

        const TEST_SUITE = [
            { id: 'fib', title: 'logic: fibonacci', unit: 'ops', weight: 0.8, fn: (n) => { const f=(x)=>x<2?x:f(x-1)+f(x-2); f(18); } },
            { id: 'prime', title: 'math: prime hunt', unit: 'found', weight: 1.2, fn: () => { 
                const s = 10000; const p = new Uint8Array(s); 
                for(let i=2;i*i<s;i++) if(!p[i]) for(let j=i*i;j<s;j+=i) p[j]=1; 
            }},
            { id: 'float', title: 'math: float stress', unit: 'flops', weight: 0.9, fn: () => { 
                for(let i=0;i<5000;i++) Math.sin(Math.random()) * Math.tan(Math.random()); 
            }},
            { id: 'matrix', title: 'compute: matrix', unit: 'ops', weight: 1.0, fn: () => {
                const s=30; const a=new Float32Array(s*s); const b=new Float32Array(s*s);
                for(let i=0;i<s*s;i++) a[i]=b[i]=Math.random();
            }},
            { id: 'json', title: 'io: json cycle', unit: 'ops/s', weight: 1.1, fn: () => {
                JSON.parse(JSON.stringify({data: Array(500).fill(Math.random())}));
            }},
            { id: 'dom', title: 'render: dom stress', unit: 'nodes', weight: 0.7, fn: () => {
                const d = document.createElement('div');
                for(let i=0;i<500;i++) { const s=document.createElement('span'); s.textContent=i; d.appendChild(s); }
            }},
            { id: 'sha', title: 'crypto: hashing', unit: 'h/s', weight: 1.3, fn: () => {
                let h=0x811c9dc5; const s="bench"+Math.random();
                for(let i=0;i<s.length;i++) h^=s.charCodeAt(i), h=Math.imul(h,0x01000193);
            }},
            { id: 'sort', title: 'array: quicksort', unit: 'sorts', weight: 0.85, fn: () => {
                const a=Float64Array.from({length:1000}, ()=>Math.random()); a.sort();
            }}
        ];

        let state = {
            running: false,
            start: 0,
            scores: {},
            iters: {},
            timers: [],
            uiTimer: null
        };

        function initUI() {
            const grid = document.getElementById('benchmarkGrid');
            grid.innerHTML = '';
            
            TEST_SUITE.forEach(t => {
                state.scores[t.id] = 0;
                state.iters[t.id] = 0;
                
                const div = document.createElement('div');
                div.className = 'benchmark-card';
                div.id = `card-${t.id}`;
                div.innerHTML = `
                    <div class="benchmark-title">${t.title} <span id="status-${t.id}">ready</span></div>
                    <div class="benchmark-score" id="score-${t.id}">0</div>
                    <div class="progress-bar"><div class="progress-fill" id="prog-${t.id}"></div></div>
                    <div class="metric"><span>${t.unit}</span><span id="iter-${t.id}">0</span></div>
                `;
                grid.appendChild(div);
            });
        }

        window.startBenchmark = function() {
            if (state.running) return;
            state.running = true;
            state.start = Date.now();
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('userName').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            
            TEST_SUITE.forEach(t => {
                state.scores[t.id] = 0;
                state.iters[t.id] = 0;
                document.getElementById(`card-${t.id}`).classList.add('running');
                document.getElementById(`status-${t.id}`).textContent = "running";
            });

            // Start Logic Loops
            TEST_SUITE.forEach(t => {
                const interval = setInterval(() => {
                    if (!state.running) return;
                    const batchStart = performance.now();
                    let ops = 0;
                    while (performance.now() - batchStart < BENCH_CONFIG.calcChunk) {
                        t.fn();
                        ops++;
                    }
                    state.iters[t.id] += ops;
                    state.scores[t.id] += (ops * t.weight * 0.5); 
                }, BENCH_CONFIG.tickRate);
                state.timers.push(interval);
            });

            animate();
        };

        function animate() {
            if (!state.running) return;

            const now = Date.now();
            const elapsed = now - state.start;
            
            document.getElementById('timer').textContent = `${(elapsed/1000).toFixed(1)}s / ${(BENCH_CONFIG.duration/1000).toFixed(1)}s`;

            let totalScore = 0;
            TEST_SUITE.forEach(t => {
                const pct = Math.min(100, (elapsed / BENCH_CONFIG.duration) * 100);
                document.getElementById(`prog-${t.id}`).style.width = `${pct}%`;
                document.getElementById(`score-${t.id}`).textContent = Math.floor(state.scores[t.id]).toLocaleString();
                document.getElementById(`iter-${t.id}`).textContent = Math.floor(state.iters[t.id]).toLocaleString();
                totalScore += state.scores[t.id];
            });

            const avgScore = totalScore / TEST_SUITE.length;
            document.getElementById('overallScore').textContent = Math.floor(avgScore).toLocaleString();

            if (elapsed >= BENCH_CONFIG.duration) {
                window.stopBenchmark();
            } else {
                requestAnimationFrame(animate);
            }
        }

        window.stopBenchmark = function() {
            state.running = false;
            state.timers.forEach(clearInterval);
            state.timers = [];

            const totalScore = Object.values(state.scores).reduce((a,b)=>a+b,0) / TEST_SUITE.length;
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('userName').disabled = false;
            document.getElementById('stopBtn').disabled = true;

            TEST_SUITE.forEach(t => {
                document.getElementById(`card-${t.id}`).classList.remove('running');
                document.getElementById(`status-${t.id}`).textContent = "done";
                document.getElementById(`prog-${t.id}`).style.width = '100%';
            });

            const name = document.getElementById('userName').value;
            window.uploadScore(name, totalScore);
        };

        window.onload = initUI;
    </script>
</body>
</html>
