<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced System Benchmark Suite</title>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Google Sans', sans-serif;
            background: #050505;
            color: #666;
            padding: 40px 20px;
            overflow-x: hidden;
            text-transform: lowercase;
        }
        .header { text-align: center; margin-bottom: 40px; }
        .header h1 { color: #444; font-size: 1.8em; margin-bottom: 8px; font-weight: 500; letter-spacing: -0.5px; }
        .header p { color: #333; font-size: 0.9em; font-weight: 500; }
        .controls { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
        input[type="text"] {
            background: #111;
            border: 1px solid #222;
            padding: 12px 15px;
            border-radius: 6px;
            color: #888;
            font-family: 'Google Sans', sans-serif;
            font-size: 0.9em;
            outline: none;
            width: 200px;
        }
        button {
            padding: 12px 35px;
            font-size: 0.95em;
            border: 1px solid #222;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            font-family: 'Google Sans', sans-serif;
            background: #111;
            color: #555;
            text-transform: lowercase;
        }
        button:hover:not(:disabled) { background: #222; border-color: #333; color: #888; }
        button:disabled { opacity: 0.3; cursor: not-allowed; }
        #reconnectBtn { background: #201010; border-color: #402020; color: #a05050; display: none; }
        .overall-score {
            text-align: center;
            margin-bottom: 20px;
            padding: 40px;
            background: linear-gradient(180deg, #0f0f0f 0%, #050505 100%);
            border-radius: 12px;
            border: 1px solid #1a1a1a;
        }
        .score-value {
            font-size: 4em;
            color: #888;
            font-weight: 500;
            letter-spacing: -2px;
            height: 1.2em;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .timer { color: #333; font-size: 0.9em; margin-top: 15px; font-weight: 500; }
        .leaderboard-wrapper {
            max-width: 800px;
            margin: 0 auto 50px auto;
            border: 1px solid #1a1a1a;
            border-radius: 8px;
            background: #080808;
            overflow: hidden;
        }
        .leaderboard-header {
            padding: 15px 20px;
            background: #0c0c0c;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #1a1a1a;
            color: #555;
        }
        .leaderboard-table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        .leaderboard-table th { text-align: left; padding: 12px 20px; color: #333; border-bottom: 1px solid #111; font-weight: 500; }
        .leaderboard-table td { padding: 12px 20px; color: #666; border-bottom: 1px solid #0f0f0f; }
        .leaderboard-content { height: auto; max-height: 400px; overflow-y: auto; background: #080808; }
        .benchmark-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .benchmark-card { background: #0c0c0c; border-radius: 8px; padding: 24px; border: 1px solid #1a1a1a; transition: all 0.3s ease; }
        .benchmark-card.running { border-color: #2a2a2a; background: #0e0e0e; }
        .benchmark-title { color: #555; font-size: 0.9em; margin-bottom: 12px; font-weight: 500; display: flex; justify-content: space-between; }
        .benchmark-score { color: #777; font-size: 2.2em; font-weight: 500; margin: 15px 0; height: 1.2em; display: flex; align-items: center; }
        .progress-bar { width: 100%; height: 2px; background: #111; margin: 20px 0; border-radius: 1px; }
        .progress-fill { height: 100%; background: #444; width: 0%; transition: width 0.1s linear; }
        .metric { display: flex; justify-content: space-between; font-size: 0.85em; color: #444; margin: 4px 0; }
        .status-msg { text-align: center; font-size: 0.75em; margin-top: -20px; margin-bottom: 20px; color: #333; }
        .slot-container { display: inline-flex; overflow: hidden; height: 1.2em; vertical-align: bottom; position: relative; width: 0.65em; justify-content: center; }
        .slot-ribbon { display: flex; flex-direction: column; transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1); position: absolute; top: 0; }
        .slot-digit { height: 1.2em; display: flex; align-items: center; justify-content: center; }
        .symbol-container { display: inline-flex; width: 0.4em; justify-content: center; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Advanced System Benchmark</h1>
        <p>Unpredictable Logic Stress Test / Global Leaderboard</p>
    </div>

    <div class="status-msg" id="authStatus">Initializing secure session...</div>

    <div class="controls">
        <input type="text" id="userName" placeholder="enter your name" maxlength="15">
        <button id="startBtn" onclick="startBenchmark()" disabled>loading...</button>
        <button id="stopBtn" onclick="stopBenchmark()" disabled>stop</button>
        <button id="reconnectBtn" onclick="handleManualReconnect()">reconnect</button>
    </div>

    <div class="overall-score">
        <h2>System performance score</h2>
        <div class="score-value" id="overallScore"></div>
        <div class="timer" id="timer">0.0s / 60.0s</div>
    </div>

    <div class="leaderboard-wrapper">
        <div class="leaderboard-header">
            <span>Top 10 Global Rankings</span>
        </div>
        <div class="leaderboard-content" id="leaderboardContent">
            <table class="leaderboard-table">
                <thead>
                    <tr>
                        <th>name</th>
                        <th>score</th>
                        <th>date</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body">
                    <tr><td colspan="3" style="text-align: center; padding: 30px;">connecting to global database...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="benchmark-grid" id="benchmarkGrid"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ENVIRONMENT DETECTION & CONFIGURATION ---
        const prodConfig = {
            apiKey: "AIzaSyCjSl69biNUauSyc5PY6SmUYfcpIwv43OI",
            authDomain: "benchbackend.firebaseapp.com",
            projectId: "benchbackend",
            storageBucket: "benchbackend.firebasestorage.app",
            messagingSenderId: "964026070166",
            appId: "1:964026070166:web:71c4a6eb59edfab03f7eb7"
        };

        const isCanvas = typeof __firebase_config !== 'undefined';
        const firebaseConfig = isCanvas ? JSON.parse(__firebase_config) : prodConfig;
        const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'benchmark-suite-default';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let user = null;
        let unsubscribeLeaderboard = null;

        async function initAuth(retries = 5, delay = 1000) {
            document.getElementById('authStatus').textContent = "Connecting to database...";
            try {
                if (initialToken && isCanvas) {
                    await signInWithCustomToken(auth, initialToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth error:", error);
                if (retries > 0) {
                    setTimeout(() => initAuth(retries - 1, delay * 2), delay);
                } else {
                    document.getElementById('authStatus').textContent = "Connection Issues - Retrying...";
                    document.getElementById('reconnectBtn').style.display = 'inline-block';
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('startBtn').textContent = "start";
                }
            }
        }

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (u) {
                document.getElementById('authStatus').textContent = "Connected securely";
                document.getElementById('startBtn').disabled = false;
                document.getElementById('startBtn').textContent = "start";
                document.getElementById('reconnectBtn').style.display = 'none';
                setupLeaderboardListener();
            }
        });

        function setupLeaderboardListener() {
            if (!user) return;
            if (unsubscribeLeaderboard) unsubscribeLeaderboard();

            /**
             * RULE 1: STRICT PATHS
             * We MUST use /artifacts/{appId}/public/data/collectionName
             * Root level collections like '/leaderboard' are blocked by security rules in this environment.
             */
            const leaderboardCollectionRef = collection(db, 'artifacts', currentAppId, 'public', 'data', 'leaderboard');
            
            /**
             * RULE 2: NO COMPLEX QUERIES
             * We avoid 'orderBy' and 'limit' here because they require composite indexes.
             * Instead, we fetch the collection and sort/limit in memory.
             */
            unsubscribeLeaderboard = onSnapshot(leaderboardCollectionRef, (snapshot) => {
                const tableBody = document.getElementById("leaderboard-body");
                const allEntries = [];
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data && typeof data.score === 'number') {
                        allEntries.push(data);
                    }
                });

                // Sort descending and take top 10
                allEntries.sort((a, b) => b.score - a.score);
                const top10 = allEntries.slice(0, 10);

                if (top10.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="3" style="text-align: center; padding: 20px;">No global scores yet.</td></tr>`;
                    return;
                }

                tableBody.innerHTML = top10.map(data => `
                    <tr>
                        <td>${data.name || 'Anonymous'}</td>
                        <td style="color: #888; font-weight: 500;">${Math.floor(data.score).toLocaleString()}</td>
                        <td style="font-size: 0.8em; color: #333;">${data.timestamp ? new Date(data.timestamp.toDate()).toLocaleDateString() : 'recent'}</td>
                    </tr>
                `).join('');
            }, (err) => {
                console.error("Leaderboard error:", err);
                document.getElementById('authStatus').textContent = "Database sync issue. Using correct path structure.";
                document.getElementById('reconnectBtn').style.display = 'inline-block';
            });
        }

        window.handleManualReconnect = () => initAuth();

        window.uploadScore = async function(userName, userScore) {
            // RULE 3: AUTH BEFORE QUERIES
            if (!user) return;
            
            try {
                // Using the MANDATORY path structure for writes
                const leaderboardCol = collection(db, 'artifacts', currentAppId, 'public', 'data', 'leaderboard');
                await addDoc(leaderboardCol, {
                    uid: user.uid,
                    name: userName || 'anonymous',
                    score: Number(userScore), 
                    timestamp: serverTimestamp()
                });
                document.getElementById('authStatus').textContent = "Score synchronized!";
                setTimeout(() => { if(user) document.getElementById('authStatus').textContent = "Connected securely"; }, 3000);
            } catch (error) {
                console.error("Upload failed:", error);
                document.getElementById('authStatus').textContent = "Upload failed - check path permissions.";
            }
        };

        initAuth();
    </script>

    <script>
        // --- Benchmark Core Logic ---
        const DURATION = 60000;
        const CALC_CHUNK_MS = 100;
        let startTime, running = false, intervals = [], visualUpdateTimer = null;
        let scores = {}, iterations = {}, finalCalculatedScore = 0;

        const benchmarks = [
            { id: 'fib', title: 'logic: fibonacci', test: fibTest, unit: 'ops/s' },
            { id: 'prime', title: 'math: prime hunt', test: primeTest, unit: 'primes/s' },
            { id: 'matrix', title: 'compute: matrix', test: matrixTest, unit: 'ops/s' },
            { id: 'sort', title: 'array: quicksort', test: sortTest, unit: 'sorts/s' },
            { id: 'hash', title: 'crypto: hashing', test: hashTest, unit: 'hashes/s' },
            { id: 'dom', title: 'render: dom stress', test: domTest, unit: 'elements/s' },
            { id: 'regex', title: 'string: regex', test: regexTest, unit: 'matches/s' },
            { id: 'mem', title: 'system: memory', test: memTest, unit: 'mb/s' },
            { id: 'float', title: 'math: float stress', test: floatTest, unit: 'flops/s' },
            { id: 'json', title: 'io: json cycle', test: jsonTest, unit: 'ops/s' }
        ];

        function updateSlotValue(elementId, value) {
            const container = document.getElementById(elementId);
            const strValue = Math.floor(value).toLocaleString();
            if (container.children.length !== strValue.length) {
                container.innerHTML = '';
                for (let char of strValue) {
                    if (char === ',' || char === '.') {
                        const sym = document.createElement('div');
                        sym.className = 'symbol-container'; sym.textContent = char;
                        container.appendChild(sym);
                    } else {
                        const slot = document.createElement('div'); slot.className = 'slot-container';
                        const ribbon = document.createElement('div'); ribbon.className = 'slot-ribbon';
                        for (let i = 0; i <= 9; i++) {
                            const d = document.createElement('div'); d.className = 'slot-digit'; d.textContent = i;
                            ribbon.appendChild(d);
                        }
                        slot.appendChild(ribbon); container.appendChild(slot);
                    }
                }
            }
            const children = Array.from(container.children);
            let strIdx = 0;
            children.forEach((child) => {
                if (child.classList.contains('slot-container')) {
                    const ribbon = child.querySelector('.slot-ribbon');
                    const digit = parseInt(strValue[strIdx]);
                    ribbon.style.transform = `translateY(-${digit * 1.2}em)`;
                }
                strIdx++;
            });
        }

        function init() {
            const grid = document.getElementById('benchmarkGrid');
            grid.innerHTML = '';
            updateSlotValue('overallScore', 0);
            benchmarks.forEach(b => {
                const card = document.createElement('div');
                card.className = 'benchmark-card'; card.id = `card-${b.id}`;
                card.innerHTML = `
                    <div class="benchmark-title">${b.title} <span id="status-${b.id}">ready</span></div>
                    <div class="benchmark-score" id="score-${b.id}"></div>
                    <div class="progress-bar"><div class="progress-fill" id="progress-${b.id}"></div></div>
                    <div class="metric"><span>${b.unit}</span><span id="iter-${b.id}">0</span></div>
                `;
                grid.appendChild(card);
                scores[b.id] = 0; iterations[b.id] = 0;
                updateSlotValue(`score-${b.id}`, 0);
            });
        }

        function startBenchmark() {
            if (running) return;
            running = true; startTime = Date.now();
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('userName').disabled = true;

            benchmarks.forEach(b => {
                document.getElementById(`card-${b.id}`).classList.add('running');
                b.test(b.id);
            });

            visualUpdateTimer = setInterval(() => {
                benchmarks.forEach(b => {
                    updateSlotValue(`score-${b.id}`, scores[b.id]);
                    document.getElementById(`iter-${b.id}`).textContent = Math.floor(iterations[b.id]).toLocaleString();
                });
                const total = Object.values(scores).reduce((a, b) => a + b, 0);
                finalCalculatedScore = total / benchmarks.length;
                updateSlotValue('overallScore', finalCalculatedScore);
            }, 750);

            requestAnimationFrame(updateLoop);
        }

        function updateLoop() {
            if (!running) return;
            const elapsed = Date.now() - startTime;
            const prog = (elapsed / DURATION) * 100;
            document.getElementById('timer').textContent = `${(elapsed/1000).toFixed(1)}s / 60.0s`;
            benchmarks.forEach(b => {
                const fill = document.getElementById(`progress-${b.id}`);
                if (fill) fill.style.width = Math.min(prog, 100) + '%';
            });
            if (elapsed >= DURATION) stopBenchmark();
            else requestAnimationFrame(updateLoop);
        }

        function stopBenchmark() {
            const wasRunning = running;
            running = false;
            clearInterval(visualUpdateTimer);
            intervals.forEach(clearInterval);
            intervals = [];
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('userName').disabled = false;
            
            if (wasRunning && typeof window.uploadScore === 'function') {
                const name = document.getElementById('userName').value || 'Anonymous';
                window.uploadScore(name, finalCalculatedScore);
            }

            benchmarks.forEach(b => {
                document.getElementById(`card-${b.id}`).classList.remove('running');
                document.getElementById(`status-${b.id}`).textContent = 'done';
            });
        }

        function createTicker(id, scoreMult, logic) {
            const int = setInterval(() => {
                if (!running) return;
                let count = 0; const start = performance.now();
                while (performance.now() - start < CALC_CHUNK_MS) { logic(); count++; }
                iterations[id] += count; scores[id] = count * scoreMult;
            }, 10);
            intervals.push(int);
        }

        function fibTest(id) { createTicker(id, 600, () => { const f = (x) => x <= 1 ? x : f(x-1) + f(x-2); f(20); }); }
        function primeTest(id) { createTicker(id, 9000, () => { let num = Math.floor(Math.random() * 5000); for(let i=2; i<=Math.sqrt(num); i++) if(num%i===0) break; }); }
        function matrixTest(id) { createTicker(id, 7500, () => { new Float64Array(400).map(() => Math.random()); }); }
        function sortTest(id) { createTicker(id, 3600, () => { Array.from({length: 100}, () => Math.random()).sort(); }); }
        function hashTest(id) { createTicker(id, 7500, () => { let h = 0, s = Math.random().toString(); for(let i=0; i<s.length; i++) h = (h<<5)-h+s.charCodeAt(i); }); }
        function domTest(id) { createTicker(id, 1200, () => { document.createElement('div').textContent = Math.random(); }); }
        function regexTest(id) { createTicker(id, 6000, () => { "pattern match".match(/pattern/g); }); }
        function memTest(id) { 
            const int = setInterval(() => {
                if (!running) return;
                let mb = 0; const start = performance.now();
                while (performance.now() - start < CALC_CHUNK_MS) { mb += (new Float64Array(1000).byteLength / 1024 / 1024); }
                iterations[id] += mb; scores[id] = Math.floor(mb * 18000);
            }, 10);
            intervals.push(int);
        }
        function floatTest(id) { createTicker(id, 4.5, () => { Math.sin(Math.random()) * Math.cos(Math.random()); }); }
        function jsonTest(id) { createTicker(id, 5400, () => { JSON.parse(JSON.stringify({a:1})); }); }

        window.addEventListener('load', init);
    </script>
</body>
</html>
