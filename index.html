<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced System Benchmark Suite</title>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Google Sans', sans-serif;
            background: #050505;
            color: #666;
            padding: 40px 20px;
            overflow-x: hidden;
            text-transform: lowercase;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #444;
            font-size: 1.8em;
            margin-bottom: 8px;
            font-weight: 500;
            letter-spacing: -0.5px;
        }

        .header p {
            color: #333;
            font-size: 0.9em;
            font-weight: 500;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        input[type="text"] {
            background: #111;
            border: 1px solid #222;
            padding: 12px 15px;
            border-radius: 6px;
            color: #888;
            font-family: 'Google Sans', sans-serif;
            font-size: 0.9em;
            outline: none;
            width: 200px;
        }

        input[type="text"]:focus {
            border-color: #444;
        }

        button {
            padding: 12px 35px;
            font-size: 0.95em;
            border: 1px solid #222;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            font-family: 'Google Sans', sans-serif;
            background: #111;
            color: #555;
            text-transform: lowercase;
        }

        button:hover:not(:disabled) {
            background: #222;
            border-color: #333;
            color: #888;
        }

        button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Slot Machine Animation */
        .slot-container {
            display: inline-flex;
            overflow: hidden;
            height: 1.2em;
            vertical-align: bottom;
            position: relative;
            width: 0.65em;
            justify-content: center;
        }

        .slot-ribbon {
            display: flex;
            flex-direction: column;
            transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            position: absolute;
            top: 0;
        }

        .slot-digit {
            height: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            font-variant-numeric: tabular-nums;
        }

        .symbol-container {
            display: inline-flex;
            width: 0.4em;
            justify-content: center;
        }

        .overall-score {
            text-align: center;
            margin-bottom: 20px;
            padding: 40px;
            background: linear-gradient(180deg, #0f0f0f 0%, #050505 100%);
            border-radius: 12px;
            border: 1px solid #1a1a1a;
        }

        .score-value {
            font-size: 4em;
            color: #888;
            font-weight: 500;
            letter-spacing: -2px;
            height: 1.2em;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .timer {
            color: #333;
            font-size: 0.9em;
            margin-top: 15px;
            font-weight: 500;
        }

        /* Leaderboard Styles */
        .leaderboard-wrapper {
            max-width: 800px;
            margin: 0 auto 50px auto;
            border: 1px solid #1a1a1a;
            border-radius: 8px;
            background: #080808;
            overflow: hidden;
        }

        .leaderboard-header {
            padding: 15px 20px;
            background: #0c0c0c;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #1a1a1a;
            user-select: none;
            color: #555;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .leaderboard-table th {
            text-align: left;
            padding: 12px 20px;
            color: #333;
            border-bottom: 1px solid #111;
            font-weight: 500;
        }

        .leaderboard-table td {
            padding: 12px 20px;
            color: #666;
            border-bottom: 1px solid #0f0f0f;
        }

        .leaderboard-content {
            height: 0;
            overflow: hidden;
            background: #080808;
            transition: height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .leaderboard-content.expanded {
            height: auto;
            max-height: 400px;
            overflow-y: auto;
        }

        .benchmark-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .benchmark-card {
            background: #0c0c0c;
            border-radius: 8px;
            padding: 24px;
            border: 1px solid #1a1a1a;
            transition: all 0.3s ease;
        }

        .benchmark-card.running {
            border-color: #2a2a2a;
            background: #0e0e0e;
        }

        .benchmark-title {
            color: #555;
            font-size: 0.9em;
            margin-bottom: 12px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
        }

        .benchmark-score {
            color: #777;
            font-size: 2.2em;
            font-weight: 500;
            margin: 15px 0;
            height: 1.2em;
            display: flex;
            align-items: center;
        }

        .progress-bar {
            width: 100%;
            height: 2px;
            background: #111;
            margin: 20px 0;
            border-radius: 1px;
        }

        .progress-fill {
            height: 100%;
            background: #444;
            width: 0%;
            transition: width 0.1s linear;
        }

        canvas {
            width: 100%;
            height: 60px;
            background: #080808;
            border: 1px solid #161616;
            opacity: 0.3;
            margin-bottom: 10px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            font-size: 0.85em;
            color: #444;
            margin: 4px 0;
        }
        
        .status-msg {
            text-align: center;
            font-size: 0.75em;
            margin-top: -20px;
            margin-bottom: 20px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Advanced System Benchmark</h1>
        <p>Unpredictable Logic Stress Test / Global Leaderboard</p>
    </div>

    <div class="status-msg" id="authStatus">Initializing secure session...</div>

    <div class="controls">
        <input type="text" id="userName" placeholder="enter your name" maxlength="15">
        <button id="startBtn" onclick="startBenchmark()" disabled>loading...</button>
        <button id="stopBtn" onclick="stopBenchmark()" disabled>stop</button>
    </div>

    <div class="overall-score">
        <h2>System performance score</h2>
        <div class="score-value" id="overallScore"></div>
        <div class="timer" id="timer">0.0s / 60.0s</div>
    </div>

    <div class="leaderboard-wrapper">
        <div class="leaderboard-header" onclick="toggleLeaderboard()">
            <span>Top 10 Global Rankings</span>
            <span id="expandIcon">expand [+]</span>
        </div>
        <div class="leaderboard-content expanded" id="leaderboardContent">
            <table class="leaderboard-table">
                <thead>
                    <tr>
                        <th>name</th>
                        <th>score</th>
                        <th>date</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body">
                    <tr>
                        <td colspan="3" style="text-align: center; padding: 30px;">connecting to live database...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="benchmark-grid" id="benchmarkGrid"></div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {
                apiKey: "AIzaSyCjSl69biNUauSyc5PY6SmUYfcpIwv43OI",
                authDomain: "benchbackend.firebaseapp.com",
                projectId: "benchbackend",
                storageBucket: "benchbackend.firebasestorage.app",
                messagingSenderId: "964026070166",
                appId: "1:964026070166:web:71c4a6eb59edfab03f7eb7"
            };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'bench-suite-v1';
        const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let user = null;

        async function initAuth() {
            try {
                if (initialToken) {
                    await signInWithCustomToken(auth, initialToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth failed:", error);
                document.getElementById('authStatus').textContent = "Connection issue. Results will be local-only.";
                document.getElementById('startBtn').disabled = false;
                document.getElementById('startBtn').textContent = "start";
            }
        }

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (u) {
                document.getElementById('authStatus').textContent = `Connected securely`;
                document.getElementById('startBtn').disabled = false;
                document.getElementById('startBtn').textContent = "start";
                setupLeaderboardListener();
            }
        });

        function setupLeaderboardListener() {
            if (!user) return;
            // RULE 1: Strict Paths
            const leaderboardCol = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
            
            // RULE 2: No Complex Queries (Fetch all, sort/limit in JS)
            onSnapshot(leaderboardCol, (snapshot) => {
                const tableBody = document.getElementById("leaderboard-body");
                const entries = [];
                
                snapshot.forEach((doc) => {
                    entries.push(doc.data());
                });

                // Sort descending by score and take top 10
                entries.sort((a, b) => (b.score || 0) - (a.score || 0));
                const top10 = entries.slice(0, 10);

                if (top10.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="3" style="text-align: center; padding: 20px;">No scores yet. Run a test!</td></tr>`;
                    return;
                }

                tableBody.innerHTML = top10.map(data => {
                    const dateStr = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleDateString() : 'recent';
                    return `<tr>
                        <td>${data.name || 'Anonymous'}</td>
                        <td style="color: #888; font-weight: 500;">${Math.floor(data.score).toLocaleString()}</td>
                        <td style="font-size: 0.8em; color: #333;">${dateStr}</td>
                    </tr>`;
                }).join('');
            }, (error) => {
                console.error("Leaderboard sync failed:", error);
            });
        }

        window.uploadScore = async function(userName, userScore) {
            if (!user) return;
            try {
                const leaderboardCol = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
                await addDoc(leaderboardCol, {
                    uid: user.uid,
                    name: userName || 'anonymous',
                    score: userScore,
                    timestamp: serverTimestamp()
                });
                document.getElementById('authStatus').textContent = "Score uploaded successfully!";
                setTimeout(() => { document.getElementById('authStatus').textContent = "Connected securely"; }, 3000);
            } catch (error) {
                console.error("Error saving score:", error);
                document.getElementById('authStatus').textContent = "Error saving score.";
            }
        };

        initAuth();
    </script>

    <script>
        const DURATION = 60000;
        const VISUAL_UPDATE_INTERVAL = 750; 
        const CALC_CHUNK_MS = 100;

        let startTime;
        let running = false;
        let intervals = [];
        let visualUpdateTimer = null;
        
        let scores = {};
        let iterations = {};
        let finalCalculatedScore = 0;

        const benchmarks = [
            { id: 'fib', title: 'randomized fibonacci', test: fibTest, unit: 'ops/s' },
            { id: 'prime', title: 'prime search range', test: primeTest, unit: 'primes/s' },
            { id: 'matrix', title: 'dynamic matrix mul', test: matrixTest, unit: 'ops/s' },
            { id: 'sort', title: 'random quicksort', test: sortTest, unit: 'sorts/s' },
            { id: 'hash', title: 'salt-based hashing', test: hashTest, unit: 'hashes/s' },
            { id: 'dom', title: 'dom node stress', test: domTest, unit: 'elements/s' },
            { id: 'regex', title: 'dynamic regex match', test: regexTest, unit: 'matches/s' },
            { id: 'mem', title: 'dynamic allocation', test: memTest, unit: 'mb/s' },
            { id: 'float', title: 'trig math stress', test: floatTest, unit: 'flops/s' },
            { id: 'json', title: 'complex json cycle', test: jsonTest, unit: 'ops/s' }
        ];

        function toggleLeaderboard() {
            const content = document.getElementById('leaderboardContent');
            const icon = document.getElementById('expandIcon');
            const isExpanded = content.classList.contains('expanded');
            
            if (isExpanded) {
                content.style.height = '0';
                content.classList.remove('expanded');
                icon.textContent = 'expand [+]';
            } else {
                content.classList.add('expanded');
                content.style.height = 'auto';
                icon.textContent = 'collapse [-]';
            }
        }

        function updateSlotValue(elementId, value) {
            const container = document.getElementById(elementId);
            const strValue = Math.floor(value).toLocaleString();
            
            if (container.children.length !== strValue.length) {
                container.innerHTML = '';
                for (let char of strValue) {
                    if (char === ',' || char === '.') {
                        const sym = document.createElement('div');
                        sym.className = 'symbol-container';
                        sym.textContent = char;
                        container.appendChild(sym);
                    } else {
                        const slot = document.createElement('div');
                        slot.className = 'slot-container';
                        const ribbon = document.createElement('div');
                        ribbon.className = 'slot-ribbon';
                        for (let i = 0; i <= 9; i++) {
                            const d = document.createElement('div');
                            d.className = 'slot-digit';
                            d.textContent = i;
                            ribbon.appendChild(d);
                        }
                        slot.appendChild(ribbon);
                        container.appendChild(slot);
                    }
                }
            }

            const children = Array.from(container.children);
            let strIdx = 0;
            children.forEach((child) => {
                if (child.classList.contains('slot-container')) {
                    const ribbon = child.querySelector('.slot-ribbon');
                    const digit = parseInt(strValue[strIdx]);
                    ribbon.style.transform = `translateY(-${digit * 1.2}em)`;
                }
                strIdx++;
            });
        }

        function init() {
            const grid = document.getElementById('benchmarkGrid');
            updateSlotValue('overallScore', 0);

            benchmarks.forEach(b => {
                const card = document.createElement('div');
                card.className = 'benchmark-card';
                card.id = `card-${b.id}`;
                card.innerHTML = `
                    <div class="benchmark-title">${b.title} <span id="status-${b.id}">ready</span></div>
                    <canvas id="canvas-${b.id}"></canvas>
                    <div class="benchmark-score" id="score-${b.id}"></div>
                    <div class="progress-bar"><div class="progress-fill" id="progress-${b.id}"></div></div>
                    <div class="metric"><span>${b.unit}</span><span id="iter-${b.id}">0</span></div>
                `;
                grid.appendChild(card);
                scores[b.id] = 0;
                iterations[b.id] = 0;
                updateSlotValue(`score-${b.id}`, 0);
            });
        }

        function startBenchmark() {
            if (running) return;
            running = true;
            startTime = Date.now();
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('userName').disabled = true;

            benchmarks.forEach(b => {
                const card = document.getElementById(`card-${b.id}`);
                if(card) card.classList.add('running');
                b.test(b.id);
            });

            visualUpdateTimer = setInterval(() => {
                benchmarks.forEach(b => {
                    updateSlotValue(`score-${b.id}`, scores[b.id]);
                    document.getElementById(`iter-${b.id}`).textContent = Math.floor(iterations[b.id]).toLocaleString();
                });
                const total = Object.values(scores).reduce((a, b) => a + b, 0);
                finalCalculatedScore = total / benchmarks.length;
                updateSlotValue('overallScore', finalCalculatedScore);
            }, VISUAL_UPDATE_INTERVAL);

            requestAnimationFrame(updateLoop);
        }

        function updateLoop() {
            if (!running) return;
            const elapsed = Date.now() - startTime;
            const prog = (elapsed / DURATION) * 100;
            document.getElementById('timer').textContent = `${(elapsed/1000).toFixed(1)}s / 60.0s`;
            benchmarks.forEach(b => {
                const fill = document.getElementById(`progress-${b.id}`);
                if (fill) fill.style.width = Math.min(prog, 100) + '%';
            });
            if (elapsed >= DURATION) stopBenchmark();
            else requestAnimationFrame(updateLoop);
        }

        function stopBenchmark() {
            const wasRunning = running;
            running = false;
            clearInterval(visualUpdateTimer);
            intervals.forEach(clearInterval);
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('userName').disabled = false;
            
            // Upload score if the benchmark completed naturally
            if (wasRunning && typeof window.uploadScore === 'function') {
                const name = document.getElementById('userName').value || 'Anonymous';
                window.uploadScore(name, finalCalculatedScore);
            }

            benchmarks.forEach(b => {
                const card = document.getElementById(`card-${b.id}`);
                const status = document.getElementById(`status-${b.id}`);
                if(card) card.classList.remove('running');
                if(status) status.textContent = 'done';
            });
        }

        // --- STRESS TESTS ---
        function fibTest(id) {
            const int = setInterval(() => {
                if (!running) return;
                let count = 0;
                const start = performance.now();
                while (performance.now() - start < CALC_CHUNK_MS) {
                    const input = 18 + Math.floor(Math.random() * 8); 
                    const f = (x) => x <= 1 ? x : f(x-1) + f(x-2);
                    f(input);
                    count++;
                }
                iterations[id] += count;
                scores[id] = count * 600; 
            }, 10);
            intervals.push(int);
        }

        function primeTest(id) {
            const int = setInterval(() => {
                if (!running) return;
                let count = 0;
                const start = performance.now();
                while (performance.now() - start < CALC_CHUNK_MS) {
                    let num = 1000 + Math.floor(Math.random() * 5000);
                    let found = 0;
                    while(found < 10) {
                        let isP = true;
                        for(let i=2; i<=Math.sqrt(num); i++) { if(num%i===0){isP=false; break;} }
                        if(isP) found++;
                        num++;
                    }
                    count++;
                }
                iterations[id] += count;
                scores[id] = count * 9000;
            }, 10);
            intervals.push(int);
        }

        function matrixTest(id) {
            const int = setInterval(() => {
                if (!running) return;
                let count = 0;
                const start = performance.now();
                while (performance.now() - start < CALC_CHUNK_MS) {
                    const size = 20 + Math.floor(Math.random() * 20);
                    const a = new Float64Array(size * size);
                    for(let i=0; i<a.length; i++) a[i] = Math.random();
                    count++;
                }
                iterations[id] += count;
                scores[id] = count * 7500;
            }, 10);
            intervals.push(int);
        }

        function sortTest(id) {
            const int = setInterval(() => {
                if (!running) return;
                let count = 0;
                const start = performance.now();
                while (performance.now() - start < CALC_CHUNK_MS) {
                    const len = 500 + Math.floor(Math.random() * 1000);
                    const a = Array.from({length: len}, () => Math.random());
                    a.sort();
                    count++;
                }
                iterations[id] += count;
                scores[id] = count * 3600;
            }, 10);
            intervals.push(int);
        }

        function hashTest(id) {
            const int = setInterval(() => {
                if (!running) return;
                let count = 0;
                const start = performance.now();
                while (performance.now() - start < CALC_CHUNK_MS) {
                    let s = Math.random().toString(36).substring(7) + Date.now();
                    let h = 0;
                    for(let i=0; i<s.length; i++) h = (h << 5) - h + s.charCodeAt(i);
                    count++;
                }
                iterations[id] += count;
                scores[id] = count * 7500;
            }, 10);
            intervals.push(int);
        }

        function domTest(id) {
            const int = setInterval(() => {
                if (!running) return;
                let count = 0;
                const start = performance.now();
                while (performance.now() - start < CALC_CHUNK_MS) {
                    const d = document.createElement('div');
                    d.textContent = Math.random();
                    count++;
                }
                iterations[id] += count;
                scores[id] = count * 1200;
            }, 10);
            intervals.push(int);
        }

        function regexTest(id) {
            const int = setInterval(() => {
                if (!running) return;
                let count = 0;
                const start = performance.now();
                while (performance.now() - start < CALC_CHUNK_MS) {
                    const salt = Math.random().toString();
                    const str = "pattern " + salt + " match ".repeat(10);
                    const regex = new RegExp(salt, 'g');
                    str.match(regex);
                    count++;
                }
                iterations[id] += count;
                scores[id] = count * 6000;
            }, 10);
            intervals.push(int);
        }

        function memTest(id) {
            const int = setInterval(() => {
                if (!running) return;
                let mb = 0;
                const start = performance.now();
                while (performance.now() - start < CALC_CHUNK_MS) {
                    const size = 5000 + Math.floor(Math.random() * 20000);
                    const a = new Float64Array(size);
                    mb += (a.byteLength / 1024 / 1024);
                }
                iterations[id] += mb;
                scores[id] = Math.floor(mb * 18000);
            }, 10);
            intervals.push(int);
        }

        function floatTest(id) {
            const int = setInterval(() => {
                if (!running) return;
                let count = 0;
                const start = performance.now();
                while (performance.now() - start < CALC_CHUNK_MS) {
                    const r = Math.random();
                    Math.sin(r) * Math.cos(r) * Math.tan(r) * Math.asin(r);
                    count++;
                }
                iterations[id] += count;
                scores[id] = count * 4.5;
            }, 10);
            intervals.push(int);
        }

        function jsonTest(id) {
            const int = setInterval(() => {
                if (!running) return;
                let count = 0;
                const start = performance.now();
                while (performance.now() - start < CALC_CHUNK_MS) {
                    const obj = { r: Math.random(), s: "str"+Math.random(), a: [Math.random()] };
                    JSON.parse(JSON.stringify(obj));
                    count++;
                }
                iterations[id] += count;
                scores[id] = count * 5400;
            }, 10);
            intervals.push(int);
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
